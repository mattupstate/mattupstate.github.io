<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 4.24.8"/><meta data-react-helmet="true" name="description" content="Matt &#x27;Upstate&#x27; Wright (He/him). Engineering team leader. Open source author and contributor. Aging hardcore punk enthusiast. LFC supporter."/><meta data-react-helmet="true" name="keywords" content="software,engineering,leadership,python,programming,open source"/><meta data-react-helmet="true" property="og:title" content="Running an ElasticSearch Cluster on CoreOS"/><meta data-react-helmet="true" property="og:description" content="Matt &#x27;Upstate&#x27; Wright (He/him). Engineering team leader. Open source author and contributor. Aging hardcore punk enthusiast. LFC supporter."/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:creator" content="Matthew Wright"/><meta data-react-helmet="true" name="twitter:title" content="Running an ElasticSearch Cluster on CoreOS"/><meta data-react-helmet="true" name="twitter:description" content="Matt &#x27;Upstate&#x27; Wright (He/him). Engineering team leader. Open source author and contributor. Aging hardcore punk enthusiast. LFC supporter."/><meta data-react-helmet="true" property="og:image" content="https://mattupstate.com/static/9798db320c5cad183af92ab85933ac64/38397/headshot-summary.png"/><meta data-react-helmet="true" property="og:image:width" content="2122"/><meta data-react-helmet="true" property="og:image:height" content="1070"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><style data-href="/styles.c743ec910f51898a4794.css" data-identity="gatsby-global-css">code[class*=language-],pre[class*=language-]{word-wrap:normal;color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{background:#073642}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#073642}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{background:#eee8d5;color:#657b83}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}

/*! tailwindcss v2.2.19 | MIT License | https://tailwindcss.com */

/*! modern-normalize v1.1.0 | MIT License | https://github.com/sindresorhus/modern-normalize */html{-webkit-text-size-adjust:100%;line-height:1.15;-moz-tab-size:4;-o-tab-size:4;tab-size:4}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;margin:0}hr{color:inherit;height:0}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{border-color:inherit;text-indent:0}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}body{font-family:inherit;line-height:inherit}*,:after,:before{border:0 solid;box-sizing:border-box}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{color:#9ca3af;opacity:1}input::placeholder,textarea::placeholder{color:#9ca3af;opacity:1}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{color:inherit;line-height:inherit;padding:0}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{height:auto;max-width:100%}*,:after,:before{--tw-border-opacity:1;border-color:rgba(229,231,235,var(--tw-border-opacity))}h1{font-size:1.5rem;line-height:2rem}h2{font-size:1.25rem;margin-bottom:.5rem}h2,h3{line-height:1.75rem}h3{font-size:1.125rem}h4,h5{font-size:1rem;line-height:1.5rem}h5{--tw-text-opacity:1;color:rgba(75,85,99,var(--tw-text-opacity));font-weight:700}p{font-size:.875rem;line-height:1.25rem}blockquote,p{margin-bottom:1rem}blockquote{--tw-bg-opacity:1;--tw-text-opacity:1;background-color:rgba(249,250,251,var(--tw-bg-opacity));border-left:3px solid gray;color:rgba(107,114,128,var(--tw-text-opacity));font-style:italic;padding:1rem}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}@media (min-width:1536px){.container{max-width:1536px}}.mx-auto{margin-left:auto;margin-right:auto}.mt-8{margin-top:2rem}.mr-0{margin-right:0}.mr-3{margin-right:.75rem}.mb-1{margin-bottom:.25rem}.mb-3{margin-bottom:.75rem}.mb-5{margin-bottom:1.25rem}.flex{display:flex}.table{display:table}.max-w-3xl{max-width:48rem}@keyframes spin{to{transform:rotate(1turn)}}@keyframes ping{75%,to{opacity:0;transform:scale(2)}}@keyframes pulse{50%{opacity:.5}}@keyframes bounce{0%,to{animation-timing-function:cubic-bezier(.8,0,1,1);transform:translateY(-25%)}50%{animation-timing-function:cubic-bezier(0,0,.2,1);transform:none}}.flex-wrap{flex-wrap:wrap}.justify-start{justify-content:flex-start}.border-2{border-width:2px}.border{border-width:1px}.bg-gray-50{--tw-bg-opacity:1;background-color:rgba(249,250,251,var(--tw-bg-opacity))}.p-4{padding:1rem}.pt-2{padding-top:.5rem}.pt-6{padding-top:1.5rem}.pr-8{padding-right:2rem}.pr-10{padding-right:2.5rem}.pb-3{padding-bottom:.75rem}.pl-5{padding-left:1.25rem}.pl-10{padding-left:2.5rem}.text-center{text-align:center}.font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}.text-xs{font-size:.75rem;line-height:1rem}.text-gray-500{--tw-text-opacity:1;color:rgba(107,114,128,var(--tw-text-opacity))}.text-gray-600{--tw-text-opacity:1;color:rgba(75,85,99,var(--tw-text-opacity))}.hover\:text-gray-500:hover{--tw-text-opacity:1;color:rgba(107,114,128,var(--tw-text-opacity))}*,:after,:before{--tw-shadow:0 0 #0000;--tw-ring-inset:var(--tw-empty,/*!*/ /*!*/);--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000}.filter{--tw-blur:var(--tw-empty,/*!*/ /*!*/);--tw-brightness:var(--tw-empty,/*!*/ /*!*/);--tw-contrast:var(--tw-empty,/*!*/ /*!*/);--tw-grayscale:var(--tw-empty,/*!*/ /*!*/);--tw-hue-rotate:var(--tw-empty,/*!*/ /*!*/);--tw-invert:var(--tw-empty,/*!*/ /*!*/);--tw-saturate:var(--tw-empty,/*!*/ /*!*/);--tw-sepia:var(--tw-empty,/*!*/ /*!*/);--tw-drop-shadow:var(--tw-empty,/*!*/ /*!*/);filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}blockquote>p{margin-bottom:0}code[class=language-text],pre[class=language-text]{font-size:.75rem;line-height:1rem}.navbar{position:sticky;top:0}.blog-post a{--tw-text-opacity:1;color:rgba(37,99,235,var(--tw-text-opacity));text-decoration:underline}.blog-post ul{font-size:.875rem;line-height:1.25rem;list-style-position:inside;list-style-type:disc;margin-bottom:1rem;margin-left:.75rem}.blog-links a{--tw-text-opacity:1;color:rgba(37,99,235,var(--tw-text-opacity));text-decoration:underline}.work ul{list-style-position:outside;list-style-type:disc;margin-bottom:1rem;margin-left:1rem}.employment p,.work ul{font-size:.75rem;line-height:1rem}.work h3{font-weight:500}.work h4{margin-bottom:.25rem}.talks a{--tw-text-opacity:1;color:rgba(37,99,235,var(--tw-text-opacity));text-decoration:underline}.talk-item{margin-bottom:2rem}.employment-duration{--tw-text-opacity:1;color:rgba(156,163,175,var(--tw-text-opacity));font-size:.875rem;line-height:1.25rem;margin-left:.25rem}.etc a,.work a{--tw-text-opacity:1;color:rgba(37,99,235,var(--tw-text-opacity));text-decoration:underline}.etc ul{font-size:.875rem;line-height:1.25rem;list-style-position:inside;list-style-type:disc;margin-bottom:1rem;margin-left:.75rem}@media (min-width:640px){.sm\:flex{display:flex}.sm\:w-2\/5{width:40%}.sm\:w-3\/5{width:60%}.sm\:justify-between{justify-content:space-between}.sm\:pt-0{padding-top:0}.sm\:pl-0{padding-left:0}}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><title data-react-helmet="true">Running an ElasticSearch Cluster on CoreOS | mattupstate.com</title><link data-react-helmet="true" rel="canonical" href="https://mattupstate.com/blog/running-an-elasticsearch-cluster-on-coreos"/><link rel="preconnect" href="https://www.googletagmanager.com"/><link rel="dns-prefetch" href="https://www.googletagmanager.com"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div><nav class="p-4 bg-gray-50 font-mono navbar"><div class="sm:flex sm:justify-between max-w-3xl mx-auto"><div>$ <a class="hover:text-gray-500" href="/">matt</a></div><div class="pl-5 pt-2 sm:pl-0 sm:pt-0"><a class="mr-3 hover:text-gray-500" href="/work">~/work</a><a class="mr-3 hover:text-gray-500" href="/talks">~/talks</a><a class="mr-0 hover:text-gray-500" href="/etc">~/etc</a></div></div></nav><div class="pl-10 pr-10 pt-6 max-w-3xl mx-auto blog-post"><h1 class="mb-1">Running an ElasticSearch Cluster on CoreOS</h1><h5 class="mb-3 text-xs text-gray-500 font-mono">Published on <!-- -->June 26, 2014</h5><hr class="mb-3"/><div><p>Recently I've been experimenting with <a href="http://www.docker.com/">Docker</a> as a build and deployment tool. During my research I stumbled onto a seemingly interesting project called <a href="https://coreos.com/">CoreOS</a>. CoreOS is a new Linux distro tailored for scheduling and deploying services across a cluster of servers. It comes packed with Docker, <a href="http://coreos.com/using-coreos/etcd/">etcd</a> (a distributed key value store), and <a href="http://coreos.com/using-coreos/clustering/">fleet</a> (a distributed init system backed by <a href="http://coreos.com/using-coreos/systemd/">systemd</a>). All really cool stuff. So I decided to check it out and see how I might deploy an <a href="http://www.elasticsearch.org/">ElasticSearch</a> cluster.</p>
<h2>Environment</h2>
<p>For the test environment I've used <a href="http://www.vagrantup.com/">Vagrant</a> given that the CoreOS team provides up-to-date CoreOS builds as Vagrant boxes. If you'd like to follow along be sure to install Vagrant first. These are the steps I took to set my environment up:</p>
<h5>1. Get the files:</h5>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell"><span class="token function">git</span> clone https://github.com/coreos/coreos-vagrant.git
<span class="token builtin class-name">cd</span> coreos-vagrant
</code></pre></div>
<h5>2. Make copies of the <code class="language-text">config.rb.example</code> and <code class="language-text">user-data.example</code> files:</h5>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell"><span class="token function">cp</span> config.rb.example config.rb
<span class="token function">cp</span> user-data.example user-data</code></pre></div>
<h5>3. Change the number of instances in <code class="language-text">config.rb</code> to 3:</h5>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token comment"># config.rb</span>
<span class="token operator">...</span>
<span class="token variable">$num_instances</span><span class="token operator">=</span><span class="token number">3</span>
<span class="token operator">...</span></code></pre></div>
<h5>4. Set the etcd discovery URL in <code class="language-text">user-data</code>:</h5>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell"><span class="token function">curl</span> http://discovery.etcd.io/new
<span class="token operator">&lt;</span>discovery-url<span class="token operator">></span>

<span class="token comment"># user-data</span>
coreos:
  etcd:
    discovery: <span class="token operator">&lt;</span>discovery-url<span class="token operator">></span>
<span class="token punctuation">..</span>.</code></pre></div>
<h5>5. Uncomment the <code class="language-text">synced_folder</code> option in <code class="language-text">Vagrantfile</code>:</h5>
<div class="gatsby-highlight" data-language="ruby"><pre class="language-ruby"><code class="language-ruby"><span class="token comment"># Vagrantfile</span>
<span class="token operator">...</span>
      config<span class="token punctuation">.</span>vm<span class="token punctuation">.</span>synced_folder <span class="token string-literal"><span class="token string">"."</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">"/home/core/share"</span></span><span class="token punctuation">,</span> <span class="token symbol">id</span><span class="token operator">:</span> <span class="token string-literal"><span class="token string">"core"</span></span><span class="token punctuation">,</span> <span class="token symbol">:nfs</span> <span class="token operator">=></span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token symbol">:mount_options</span> <span class="token operator">=></span> <span class="token punctuation">[</span><span class="token string-literal"><span class="token string">'nolock,vers=3,udp'</span></span><span class="token punctuation">]</span>
<span class="token operator">...</span></code></pre></div>
<h5>6. Start the machines:</h5>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">vagrant up</code></pre></div>
<h5>7. Verify the cluster:</h5>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">vagrant <span class="token function">ssh</span> core-01 -- <span class="token parameter variable">-A</span>
Last login: Wed Jun <span class="token number">25</span> <span class="token number">23</span>:57:32 <span class="token number">2014</span> from <span class="token number">10.0</span>.2.2
CoreOS <span class="token punctuation">(</span>alpha<span class="token punctuation">)</span>
core@core-01 ~ $ fleetctl list-machines
MACHINE     IP      METADATA
4874973d<span class="token punctuation">..</span>. <span class="token number">172.17</span>.8.102    -
7f0af17f<span class="token punctuation">..</span>. <span class="token number">172.17</span>.8.103    -
847600c0<span class="token punctuation">..</span>. <span class="token number">172.17</span>.8.101    -
</code></pre></div>
<h2>Service Units</h2>
<p>To run the cluster I've decided to use two service units, one for ElasticSearch itself and another to act as a "discovery" service. One instance of each service will be deployed to each machine in the cluster for a total of six service instances.</p>
<h3>Discovery Service</h3>
<p>The Discovery Sevice will act as a sort of health check for an ElasticSearch service. This is enabled with a basic bash script that sets a key for the machine in etcd if the service is available or removes the key if the service is not available. The idea here is that when additional ElasticSearch instances are deployed they can join the cluster by asking etcd for the currently deployed ElasticSearch services. The discovery service looks this:</p>
<div class="gatsby-highlight" data-language="ini"><pre class="language-ini"><code class="language-ini"><span class="token comment"># elasticsearch-discovery@.service</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Unit</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">Description</span><span class="token punctuation">=</span><span class="token value attr-value">ElasticSearch discovery service</span>
<span class="token key attr-name">BindsTo</span><span class="token punctuation">=</span><span class="token value attr-value">elasticsearch@%i.service</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Service</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">EnvironmentFile</span><span class="token punctuation">=</span><span class="token value attr-value">/etc/environment</span>

<span class="token key attr-name">ExecStart</span><span class="token punctuation">=</span><span class="token value attr-value">/bin/bash -c '\</span>
  while true; do \
    curl -f ${COREOS_PRIVATE_IPV4}:9200; \
    <span class="token key attr-name">if [ "$?"</span> <span class="token punctuation">=</span> <span class="token value attr-value">"0" ]; then \</span>
      etcdctl set /services/elasticsearch/${COREOS_PRIVATE_IPV4} \'{"http_port": 9200, "transport_port": 9300}\' --ttl 60; \
    else \
      etcdctl rm /services/elasticsearch/${COREOS_PRIVATE_IPV4}; \
    fi; \
    sleep 45; \
  done'

<span class="token key attr-name">ExecStop</span><span class="token punctuation">=</span><span class="token value attr-value">/usr/bin/etcdctl rm /services/elasticsearch/${COREOS_PRIVATE_IPV4}</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">X-Fleet</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">X-ConditionMachineOf</span><span class="token punctuation">=</span><span class="token value attr-value">elasticsearch@%i.service</span></code></pre></div>
<p>The bash script that does the work uses <code class="language-text">curl</code> to make a request to the local ElasticSearch service running on port 9200. Passing the <code class="language-text">-f</code> flag to <code class="language-text">curl</code> allows one to get a more meaningful exit code and in this case it is used as the conditional to set or remove the key in etcd. Take note of the <code class="language-text">BindsTo=</code> directive. This tells <code class="language-text">systemd</code> that this service should be started only when the corresponding ElasticSearch service is started. Additionally, I've specified that this service should be deployed to the same machine as the corresponding ElasticSearch service with the <code class="language-text">X-ConditionMachineOf=</code> directive.</p>
<h3>ElasticSearch Service</h3>
<p>The ElasticSearch Service runs, not surprisingly, ElasticSearch. The service looks like this:</p>
<div class="gatsby-highlight" data-language="ini"><pre class="language-ini"><code class="language-ini"><span class="token comment"># elasticsearch@.service</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Unit</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">Description</span><span class="token punctuation">=</span><span class="token value attr-value">ElasticSearch service</span>
<span class="token key attr-name">After</span><span class="token punctuation">=</span><span class="token value attr-value">docker.service</span>
<span class="token key attr-name">Requires</span><span class="token punctuation">=</span><span class="token value attr-value">docker.service</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Service</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">TimeoutSec</span><span class="token punctuation">=</span><span class="token value attr-value">180</span>
<span class="token key attr-name">EnvironmentFile</span><span class="token punctuation">=</span><span class="token value attr-value">/etc/environment</span>

<span class="token key attr-name">ExecStartPre</span><span class="token punctuation">=</span><span class="token value attr-value">/usr/bin/mkdir -p /data/elasticsearch</span>
<span class="token key attr-name">ExecStartPre</span><span class="token punctuation">=</span><span class="token value attr-value">/usr/bin/docker pull dockerfile/elasticsearch</span>

<span class="token key attr-name">ExecStart</span><span class="token punctuation">=</span><span class="token value attr-value">/bin/bash -c '\</span>
  curl -f ${COREOS_PRIVATE_IPV4}:4001/v2/keys/services/elasticsearch; \
  <span class="token key attr-name">if [ "$?"</span> <span class="token punctuation">=</span> <span class="token value attr-value">"0" ]; then \</span>
      <span class="token key attr-name">UNICAST_HOSTS</span><span class="token punctuation">=</span><span class="token value attr-value">$(etcdctl ls --recursive /services/elasticsearch \</span>
                      | sed "s/\/services\/elasticsearch\///g" \
                      | sed "s/$/:9300/" \
                      | paste -s -d","); \
  else \
      <span class="token key attr-name">UNICAST_HOSTS</span><span class="token punctuation">=</span><span class="token value attr-value">""; \</span>
  fi; \
  /usr/bin/docker run \
    --name %p-%i \
    --publish 9200:9200 \
    --publish 9300:9300 \
    --volume /data/elasticsearch:/data \
    dockerfile/elasticsearch \
    /elasticsearch/bin/elasticsearch \
    <span class="token key attr-name">--node.name</span><span class="token punctuation">=</span><span class="token value attr-value">%p-%i \</span>
    <span class="token key attr-name">--cluster.name</span><span class="token punctuation">=</span><span class="token value attr-value">logstash \</span>
    <span class="token key attr-name">--network.publish_host</span><span class="token punctuation">=</span><span class="token value attr-value">${COREOS_PRIVATE_IPV4} \</span>
    <span class="token key attr-name">--discovery.zen.ping.multicast.enabled</span><span class="token punctuation">=</span><span class="token value attr-value">false \</span>
    <span class="token key attr-name">--discovery.zen.ping.unicast.hosts</span><span class="token punctuation">=</span><span class="token value attr-value">$UNICAST_HOSTS'</span>

<span class="token key attr-name">ExecStop</span><span class="token punctuation">=</span><span class="token value attr-value">/usr/bin/docker stop %p-%i</span>
<span class="token key attr-name">ExecStop</span><span class="token punctuation">=</span><span class="token value attr-value">/usr/bin/docker rm %p-%i</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">X-Fleet</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">X-Conflicts</span><span class="token punctuation">=</span><span class="token value attr-value">%p@*.service</span></code></pre></div>
<p>First note that a directory is created in a <code class="language-text">ExecStartPre=</code> directive on the host machine to store the ElasticSearch data. This is then mounted to the Docker container and allows the ElasticSearch data to survive service restarts. Next of note is the bash script that starts ElasticSearch. In this script a variable is conditionally set to a comma separated list of IP and port pairs for the currently running ElasticSearch services. This variable is then used to configure the service's unicast hosts option so that the new service will join the cluster. Unicast is used here because multicast is not supported in a Docker environment. Lastly, the <code class="language-text">X-Conflicts=</code> directive ensures that there will be but one ElasticSearch service per machine in the cluster.</p>
<h2>Deploying</h2>
<p>Deploying the services is done with the <code class="language-text">fleetctl</code> command line tool. It is a good idea to first deploy the Discovery Service so that it will automatically be started when the ElasticSearch Service is deployed. First, make sure you have ssh'd into one of the machines and using the synced folder as your working directory:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">vagrant <span class="token function">ssh</span> core-01 -- <span class="token parameter variable">-A</span>
Last login: Wed Jun <span class="token number">25</span> <span class="token number">23</span>:57:32 <span class="token number">2014</span> from <span class="token number">10.0</span>.2.2
CoreOS <span class="token punctuation">(</span>alpha<span class="token punctuation">)</span>
core@core-01 ~ $ <span class="token builtin class-name">cd</span> share</code></pre></div>
<p>The next step is to "submit" the Discovery Service to <code class="language-text">fleet</code> so that it is ready and waiting for the upcoming ElasticSearch services to be deployed:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">core@core-01 ~/share $ fleetctl submit elasticsearch-discovery@<span class="token punctuation">{</span><span class="token number">1,2</span>,3<span class="token punctuation">}</span>.service</code></pre></div>
<p>Now its time to start and wait for at least one ElasticSearch service to be deployed:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">core@core-01 ~/share $ fleetctl start elasticsearch@1.service
Job elasticsearch@1.service launched on 7f0af17f<span class="token punctuation">..</span>./172.17.8.103</code></pre></div>
<p>This first time this is deployed it can take a little while since Docker will have to pull the <code class="language-text">dockerfile/elasticsearch</code> image from the public registry the first time. Normally <code class="language-text">systemd</code> would timeout, but I've added a <code class="language-text">TimeoutSec=</code> directive to the service unit to allow for this condition. If you want to watch the progress of this first service as it starts up you can tail the logs by running the <code class="language-text">fleetctl journal</code> command. You should see something like this:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">core@core-01 ~/share $ fleetctl journal <span class="token parameter variable">-f</span> elasticsearch@1.service
-- Logs begin at Wed <span class="token number">2014</span>-06-25 <span class="token number">18</span>:03:29 UTC. --
Jun <span class="token number">26</span> 03:08:57 core-03 systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Starting ElasticSearch service<span class="token punctuation">..</span>.
Jun <span class="token number">26</span> 03:08:57 core-03 docker<span class="token punctuation">[</span><span class="token number">31109</span><span class="token punctuation">]</span>: Pulling repository dockerfile/elasticsearch
Jun <span class="token number">26</span> 03:09:01 core-03 docker<span class="token punctuation">[</span><span class="token number">31136</span><span class="token punctuation">]</span>: Pulling repository dockerfile/elasticsearch
Jun <span class="token number">26</span> 03:09:04 core-03 systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Started ElasticSearch service.
Jun <span class="token number">26</span> 03:09:04 core-03 bash<span class="token punctuation">[</span><span class="token number">31144</span><span class="token punctuation">]</span>: % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
Jun <span class="token number">26</span> 03:09:04 core-03 bash<span class="token punctuation">[</span><span class="token number">31144</span><span class="token punctuation">]</span>: Dload  Upload   Total   Spent    Left  Speed
Jun <span class="token number">26</span> 03:09:04 core-03 bash<span class="token punctuation">[</span><span class="token number">31144</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span>155B blob data<span class="token punctuation">]</span>
Jun <span class="token number">26</span> 03:09:06 core-03 bash<span class="token punctuation">[</span><span class="token number">31144</span><span class="token punctuation">]</span>: <span class="token punctuation">{</span><span class="token string">"action"</span><span class="token builtin class-name">:</span><span class="token string">"get"</span>,<span class="token string">"node"</span>:<span class="token punctuation">{</span><span class="token string">"key"</span><span class="token builtin class-name">:</span><span class="token string">"/services/elasticsearch"</span>,<span class="token string">"dir"</span>:true,<span class="token string">"modifiedIndex"</span>:493,<span class="token string">"createdIndex"</span>:493<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:09:06,159<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>node                     <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-1<span class="token punctuation">]</span> version<span class="token punctuation">[</span><span class="token number">1.2</span>.1<span class="token punctuation">]</span>, pid<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>, build<span class="token punctuation">[</span>6c95b75/2014-06-03T15:02:52Z<span class="token punctuation">]</span>
Jun <span class="token number">26</span> 03:09:06 core-03 bash<span class="token punctuation">[</span><span class="token number">31144</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:09:06,160<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>node                     <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-1<span class="token punctuation">]</span> initializing <span class="token punctuation">..</span>.
Jun <span class="token number">26</span> 03:09:06 core-03 bash<span class="token punctuation">[</span><span class="token number">31144</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:09:06,167<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>plugins                  <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-1<span class="token punctuation">]</span> loaded <span class="token punctuation">[</span><span class="token punctuation">]</span>, sites <span class="token punctuation">[</span><span class="token punctuation">]</span>
Jun <span class="token number">26</span> 03:09:09 core-03 bash<span class="token punctuation">[</span><span class="token number">31144</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:09:09,432<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>node                     <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-1<span class="token punctuation">]</span> initialized
Jun <span class="token number">26</span> 03:09:09 core-03 bash<span class="token punctuation">[</span><span class="token number">31144</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:09:09,433<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>node                     <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-1<span class="token punctuation">]</span> starting <span class="token punctuation">..</span>.
Jun <span class="token number">26</span> 03:09:09 core-03 bash<span class="token punctuation">[</span><span class="token number">31144</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:09:09,521<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>transport                <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-1<span class="token punctuation">]</span> bound_address <span class="token punctuation">{</span>inet<span class="token punctuation">[</span>/0:0:0:0:0:0:0:0:9300<span class="token punctuation">]</span><span class="token punctuation">}</span>, publish_address <span class="token punctuation">{</span>inet<span class="token punctuation">[</span>/172.17.8.103:9300<span class="token punctuation">]</span><span class="token punctuation">}</span>
Jun <span class="token number">26</span> 03:09:12 core-03 bash<span class="token punctuation">[</span><span class="token number">31144</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:09:12,551<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>cluster.service          <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-1<span class="token punctuation">]</span> new_master <span class="token punctuation">[</span>elasticsearch-1<span class="token punctuation">]</span><span class="token punctuation">[</span>oDMLhfaqQPupW-Kx7053Eg<span class="token punctuation">]</span><span class="token punctuation">[</span>528834ab92f2<span class="token punctuation">]</span><span class="token punctuation">[</span>inet<span class="token punctuation">[</span>/172.17.8.103:9300<span class="token punctuation">]</span><span class="token punctuation">]</span>, reason: zen-disco-join <span class="token punctuation">(</span>elected_as_master<span class="token punctuation">)</span>
Jun <span class="token number">26</span> 03:09:12 core-03 bash<span class="token punctuation">[</span><span class="token number">31144</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:09:12,595<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>discovery                <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-1<span class="token punctuation">]</span> logstash/oDMLhfaqQPupW-Kx7053Eg
Jun <span class="token number">26</span> 03:09:12 core-03 bash<span class="token punctuation">[</span><span class="token number">31144</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:09:12,627<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>http                     <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-1<span class="token punctuation">]</span> bound_address <span class="token punctuation">{</span>inet<span class="token punctuation">[</span>/0:0:0:0:0:0:0:0:9200<span class="token punctuation">]</span><span class="token punctuation">}</span>, publish_address <span class="token punctuation">{</span>inet<span class="token punctuation">[</span>/172.17.8.103:9200<span class="token punctuation">]</span><span class="token punctuation">}</span>
Jun <span class="token number">26</span> 03:09:12 core-03 bash<span class="token punctuation">[</span><span class="token number">31144</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:09:12,648<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>gateway                  <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-1<span class="token punctuation">]</span> recovered <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> indices into cluster_state
Jun <span class="token number">26</span> 03:09:12 core-03 bash<span class="token punctuation">[</span><span class="token number">31144</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:09:12,649<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>node                     <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-1<span class="token punctuation">]</span> started</code></pre></div>
<p>Once the first ElasticSearch service is up and running you can now add additional "nodes" to the cluster by running additional services:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">core@core-01 ~/share fleetctl start elasticsearch@<span class="token punctuation">{</span><span class="token number">2,3</span><span class="token punctuation">}</span>.service
Job elasticsearch@2.service launched on 847600c0<span class="token punctuation">..</span>./172.17.8.101
Job elasticsearch@3.service launched on 4874973d<span class="token punctuation">..</span>./172.17.8.102</code></pre></div>
<p>And again, tail one of the services to watch the startup progress:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">core@core-01 ~/share $ fleetctl journal <span class="token parameter variable">-f</span> elasticsearch@2.service
-- Logs begin at Wed <span class="token number">2014</span>-06-25 <span class="token number">18</span>:02:30 UTC. --
Jun <span class="token number">26</span> 03:15:27 core-01 systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Starting ElasticSearch service<span class="token punctuation">..</span>.
Jun <span class="token number">26</span> 03:15:27 core-01 docker<span class="token punctuation">[</span><span class="token number">31265</span><span class="token punctuation">]</span>: Pulling repository dockerfile/elasticsearch
Jun <span class="token number">26</span> 03:15:29 core-01 docker<span class="token punctuation">[</span><span class="token number">31286</span><span class="token punctuation">]</span>: Pulling repository dockerfile/elasticsearch
Jun <span class="token number">26</span> 03:15:32 core-01 systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Started ElasticSearch service.
Jun <span class="token number">26</span> 03:15:32 core-01 bash<span class="token punctuation">[</span><span class="token number">31299</span><span class="token punctuation">]</span>: % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
Jun <span class="token number">26</span> 03:15:32 core-01 bash<span class="token punctuation">[</span><span class="token number">31299</span><span class="token punctuation">]</span>: Dload  Upload   Total   Spent    Left  Speed
Jun <span class="token number">26</span> 03:15:32 core-01 bash<span class="token punctuation">[</span><span class="token number">31299</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span>155B blob data<span class="token punctuation">]</span>
Jun <span class="token number">26</span> 03:15:33 core-01 bash<span class="token punctuation">[</span><span class="token number">31299</span><span class="token punctuation">]</span>: <span class="token punctuation">{</span><span class="token string">"action"</span><span class="token builtin class-name">:</span><span class="token string">"get"</span>,<span class="token string">"node"</span>:<span class="token punctuation">{</span><span class="token string">"key"</span><span class="token builtin class-name">:</span><span class="token string">"/services/elasticsearch"</span>,<span class="token string">"dir"</span>:true,<span class="token string">"nodes"</span>:<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"key"</span><span class="token builtin class-name">:</span><span class="token string">"/services/elasticsearch/172.17.8.103"</span>,<span class="token string">"value"</span><span class="token builtin class-name">:</span><span class="token string">"{<span class="token entity" title="\&quot;">\"</span>http_port<span class="token entity" title="\&quot;">\"</span>: 9200, <span class="token entity" title="\&quot;">\"</span>transport_port<span class="token entity" title="\&quot;">\"</span>: 9300}"</span>,<span class="token string">"expiration"</span><span class="token builtin class-name">:</span><span class="token string">"2014-06-26T03:16:10.516041728Z"</span>,<span class="token string">"ttl"</span>:39,<span class="token string">"modifiedIndex"</span>:35199,<span class="token string">"createdIndex"</span>:35199<span class="token punctuation">}</span><span class="token punctuation">]</span>,<span class="token string">"modifiedIndex"</span>:493,<span class="token string">"createdIndex"</span>:493<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:15:33,505<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>node                     <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-2<span class="token punctuation">]</span> version<span class="token punctuation">[</span><span class="token number">1.2</span>.1<span class="token punctuation">]</span>, pid<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>, build<span class="token punctuation">[</span>6c95b75/2014-06-03T15:02:52Z<span class="token punctuation">]</span>
Jun <span class="token number">26</span> 03:15:33 core-01 bash<span class="token punctuation">[</span><span class="token number">31299</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:15:33,506<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>node                     <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-2<span class="token punctuation">]</span> initializing <span class="token punctuation">..</span>.
Jun <span class="token number">26</span> 03:15:33 core-01 bash<span class="token punctuation">[</span><span class="token number">31299</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:15:33,512<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>plugins                  <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-2<span class="token punctuation">]</span> loaded <span class="token punctuation">[</span><span class="token punctuation">]</span>, sites <span class="token punctuation">[</span><span class="token punctuation">]</span>
Jun <span class="token number">26</span> 03:15:36 core-01 bash<span class="token punctuation">[</span><span class="token number">31299</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:15:36,907<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>node                     <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-2<span class="token punctuation">]</span> initialized
Jun <span class="token number">26</span> 03:15:36 core-01 bash<span class="token punctuation">[</span><span class="token number">31299</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:15:36,908<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>node                     <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-2<span class="token punctuation">]</span> starting <span class="token punctuation">..</span>.
Jun <span class="token number">26</span> 03:15:37 core-01 bash<span class="token punctuation">[</span><span class="token number">31299</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:15:37,001<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>transport                <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-2<span class="token punctuation">]</span> bound_address <span class="token punctuation">{</span>inet<span class="token punctuation">[</span>/0:0:0:0:0:0:0:0:9300<span class="token punctuation">]</span><span class="token punctuation">}</span>, publish_address <span class="token punctuation">{</span>inet<span class="token punctuation">[</span>/172.17.8.101:9300<span class="token punctuation">]</span><span class="token punctuation">}</span>
Jun <span class="token number">26</span> 03:15:40 core-01 bash<span class="token punctuation">[</span><span class="token number">31299</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:15:40,133<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>cluster.service          <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-2<span class="token punctuation">]</span> detected_master <span class="token punctuation">[</span>elasticsearch-1<span class="token punctuation">]</span><span class="token punctuation">[</span>oDMLhfaqQPupW-Kx7053Eg<span class="token punctuation">]</span><span class="token punctuation">[</span>528834ab92f2<span class="token punctuation">]</span><span class="token punctuation">[</span>inet<span class="token punctuation">[</span>/172.17.8.103:9300<span class="token punctuation">]</span><span class="token punctuation">]</span>, added <span class="token punctuation">{</span><span class="token punctuation">[</span>elasticsearch-1<span class="token punctuation">]</span><span class="token punctuation">[</span>oDMLhfaqQPupW-Kx7053Eg<span class="token punctuation">]</span><span class="token punctuation">[</span>528834ab92f2<span class="token punctuation">]</span><span class="token punctuation">[</span>inet<span class="token punctuation">[</span>/172.17.8.103:9300<span class="token punctuation">]</span><span class="token punctuation">]</span>,<span class="token punctuation">}</span>, reason: zen-disco-receive<span class="token punctuation">(</span>from master <span class="token punctuation">[</span><span class="token punctuation">[</span>elasticsearch-1<span class="token punctuation">]</span><span class="token punctuation">[</span>oDMLhfaqQPupW-Kx7053Eg<span class="token punctuation">]</span><span class="token punctuation">[</span>528834ab92f2<span class="token punctuation">]</span><span class="token punctuation">[</span>inet<span class="token punctuation">[</span>/172.17.8.103:9300<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
Jun <span class="token number">26</span> 03:15:40 core-01 bash<span class="token punctuation">[</span><span class="token number">31299</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:15:40,174<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>discovery                <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-2<span class="token punctuation">]</span> logstash/fnMFB1wMTZmNiQ96MS3cQw
Jun <span class="token number">26</span> 03:15:40 core-01 bash<span class="token punctuation">[</span><span class="token number">31299</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:15:40,182<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>http                     <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-2<span class="token punctuation">]</span> bound_address <span class="token punctuation">{</span>inet<span class="token punctuation">[</span>/0:0:0:0:0:0:0:0:9200<span class="token punctuation">]</span><span class="token punctuation">}</span>, publish_address <span class="token punctuation">{</span>inet<span class="token punctuation">[</span>/172.17.8.101:9200<span class="token punctuation">]</span><span class="token punctuation">}</span>
Jun <span class="token number">26</span> 03:15:40 core-01 bash<span class="token punctuation">[</span><span class="token number">31299</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:15:40,186<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>node                     <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-2<span class="token punctuation">]</span> started
Jun <span class="token number">26</span> 03:15:42 core-01 bash<span class="token punctuation">[</span><span class="token number">31299</span><span class="token punctuation">]</span>: <span class="token punctuation">[</span><span class="token number">2014</span>-06-26 03:15:42,692<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO <span class="token punctuation">]</span><span class="token punctuation">[</span>cluster.service          <span class="token punctuation">]</span> <span class="token punctuation">[</span>elasticsearch-2<span class="token punctuation">]</span> added <span class="token punctuation">{</span><span class="token punctuation">[</span>elasticsearch-3<span class="token punctuation">]</span><span class="token punctuation">[</span>F5mpLliyS5m6Hl5-GI59Sg<span class="token punctuation">]</span><span class="token punctuation">[</span>e72be2b7be66<span class="token punctuation">]</span><span class="token punctuation">[</span>inet<span class="token punctuation">[</span>/172.17.8.102:9300<span class="token punctuation">]</span><span class="token punctuation">]</span>,<span class="token punctuation">}</span>, reason: zen-disco-receive<span class="token punctuation">(</span>from master <span class="token punctuation">[</span><span class="token punctuation">[</span>elasticsearch-1<span class="token punctuation">]</span><span class="token punctuation">[</span>oDMLhfaqQPupW-Kx7053Eg<span class="token punctuation">]</span><span class="token punctuation">[</span>528834ab92f2<span class="token punctuation">]</span><span class="token punctuation">[</span>inet<span class="token punctuation">[</span>/172.17.8.103:9300<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div>
<p>Notice in the log output that the new service has detected the first service as the master node! Finally, its just a good idea to verify the state of the ElasticSearch cluster with a plain old <code class="language-text">curl</code> call:</p>
<div class="gatsby-highlight" data-language="shell"><pre class="language-shell"><code class="language-shell">core@core-01 ~/share $ <span class="token function">curl</span> localhost:9200/_cluster/state?pretty<span class="token operator">=</span>true
<span class="token punctuation">{</span>
  <span class="token string">"cluster_name"</span> <span class="token builtin class-name">:</span> <span class="token string">"logstash"</span>,
  <span class="token string">"version"</span> <span class="token builtin class-name">:</span> <span class="token number">5</span>,
  <span class="token string">"master_node"</span> <span class="token builtin class-name">:</span> <span class="token string">"oDMLhfaqQPupW-Kx7053Eg"</span>,
  <span class="token string">"blocks"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>,
  <span class="token string">"nodes"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"oDMLhfaqQPupW-Kx7053Eg"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"elasticsearch-1"</span>,
      <span class="token string">"transport_address"</span> <span class="token builtin class-name">:</span> <span class="token string">"inet[/172.17.8.103:9300]"</span>,
      <span class="token string">"attributes"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"fnMFB1wMTZmNiQ96MS3cQw"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"elasticsearch-2"</span>,
      <span class="token string">"transport_address"</span> <span class="token builtin class-name">:</span> <span class="token string">"inet[/172.17.8.101:9300]"</span>,
      <span class="token string">"attributes"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>,
    <span class="token string">"F5mpLliyS5m6Hl5-GI59Sg"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"elasticsearch-3"</span>,
      <span class="token string">"transport_address"</span> <span class="token builtin class-name">:</span> <span class="token string">"inet[/172.17.8.102:9300]"</span>,
      <span class="token string">"attributes"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"metadata"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"templates"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>,
    <span class="token string">"indices"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"routing_table"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"indices"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"routing_nodes"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">"unassigned"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>,
    <span class="token string">"nodes"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
      <span class="token string">"oDMLhfaqQPupW-Kx7053Eg"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>,
      <span class="token string">"F5mpLliyS5m6Hl5-GI59Sg"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>,
      <span class="token string">"fnMFB1wMTZmNiQ96MS3cQw"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"allocations"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Hooray! All three nodes are in the cluster.</p>
<h2>Conclusion</h2>
<p>So I think its safe to say that you could easily run an ElasticSearch cluster on CoreOS. However, I wouldn't say this is ready for a production environment quite yet given that CoreOS is still under very heavy development. But this is certainly very promising and feels like a great way to deploy apps and services.</p>
<p>So what now? Well, ElasticSearch can be used for all sorts of things. One of the most common use cases that I'm familiar with is for log aggregation. This <em>could</em> be enabled by running a <a href="http://logstash.net/">Logstash</a> agent and a <a href="https://github.com/progrium/logspout">logspout</a> container on each machine. In fact, I've prototyped this and will write more about this in a later post!</p></div></div><div class="pl-10 pr-10 pt-6 max-w-3xl mx-auto text-center text-xs mb-5 font-mono"><hr class="mt-8 mb-3"/>Copyright  Matthew Wright 2022<br/>Built with <a href="https://www.gatsbyjs.com/">Gatsby</a>, <a href="https://tailwindcss.com/">tailwindcss</a> &amp; <a href="https://pages.github.com/">GitHub Pages</a><br/>Find me on <a href="https://mastodon.social/@mattupstate" rel="me">Mastodon</a></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EKT2WF2WDQ"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-EKT2WF2WDQ', {"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/running-an-elasticsearch-cluster-on-coreos/";window.___webpackCompilationHash="27953d9332d750d3ca74";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-c5c0181d4d3c3787c4a6.js"],"app":["/app-f1d5148060cce5abe405.js"],"component---src-pages-404-js":["/component---src-pages-404-js-fcfd776236d0c701b588.js"],"component---src-pages-etc-js":["/component---src-pages-etc-js-fffe2ea45aab2f531e71.js"],"component---src-pages-index-js":["/component---src-pages-index-js-3cbe8272dfbe42e348d1.js"],"component---src-pages-markdown-remark-frontmatter-slug-js":["/component---src-pages-markdown-remark-frontmatter-slug-js-a650d894f7d1c2a811e6.js"],"component---src-pages-talks-js":["/component---src-pages-talks-js-5e587e6275856c4b6519.js"],"component---src-pages-work-js":["/component---src-pages-work-js-90a6c2b2d4c8822fbaa0.js"]};/*]]>*/</script><script src="/polyfill-c5c0181d4d3c3787c4a6.js" nomodule=""></script><script src="/app-f1d5148060cce5abe405.js" async=""></script><script src="/532a2f07-22a38091beea14ab1e64.js" async=""></script><script src="/framework-f71dcd04c2811ba676c8.js" async=""></script><script src="/webpack-runtime-868a2427797d52a8ad6c.js" async=""></script></body></html>